<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Herramienta de votación interactiva de Derecho Civil">
    <title>Sondeo: Régimen de Servidumbres</title>
    <style>
        /* --- FUENTES Y VARIABLES --- */
        :root {
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --primary-color: #007AFF;
            --primary-hover: #0062cc;
            --success-color: #34C759;
            --error-color: #FF3B30;
            --text-dark: #1d1d1f;
            --text-secondary: #86868b;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.4);
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --bar-bg: #e0e0e0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: #111;
            /* Fondo compuesto: Imagen + Gradiente de respaldo */
            background-image: url('Gemini_Generated_Image_5r5o1d5r5o1d5r5o.jpg'), linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-dark);
        }

        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .container {
            width: 95%;
            max-width: 950px;
            margin: 20px auto;
            perspective: 1200px;
        }

        /* --- PANTALLAS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow-glass);
            padding: 2.5rem;
            color: var(--text-dark);
            text-align: center;
        }

        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }

        h1 { font-size: 2.2rem; margin-bottom: 0.5rem; color: #000; }
        .subtitle { font-size: 1.1rem; color: #333; margin-bottom: 1rem; }
        
        .creators {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 2rem;
            font-style: italic;
            padding: 10px;
            background: rgba(255,255,255,0.4);
            border-radius: 12px;
        }

        /* Botones Generales */
        .btn-main {
            background: var(--primary-color);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        .btn-main:hover { background: var(--primary-hover); transform: translateY(-2px); }

        .btn-select {
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.1);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        .btn-select.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* --- TARJETA FLIP --- */
        .flip-card {
            background-color: transparent;
            width: 100%;
            height: 750px; 
            perspective: 1200px;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 24px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            overflow-y: auto;
        }

        .flip-card-back { transform: rotateY(180deg); }

        /* --- UI PREGUNTA (FRENTE) --- */
        .top-bar {
            display: flex; justify-content: space-between; 
            margin-bottom: 1rem; color: #555; font-weight: 600;
        }
        .question-text {
            font-size: 1.4rem; margin-bottom: 1.5rem; color: #000; font-weight: 700;
        }

        /* Grid de votación */
        .voting-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .vote-row {
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        /* Barra de progreso de fondo */
        .vote-bar-bg {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            background: rgba(0, 122, 255, 0.1);
            width: 0%;
            transition: width 0.3s ease;
            z-index: 0;
        }

        .vote-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .option-text {
            text-align: left;
            font-size: 0.95rem;
            flex: 1;
            padding-right: 10px;
        }

        .vote-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.5);
            padding: 4px;
            border-radius: 8px;
        }

        .btn-vote {
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .btn-vote:hover { background: #f0f0f0; }
        .btn-vote:active { transform: scale(0.95); }

        .vote-count {
            font-weight: bold;
            min-width: 25px;
            text-align: center;
            color: var(--primary-color);
        }

        /* Footer del frente */
        .action-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding-top: 10px;
            gap: 10px;
        }

        .btn-reveal {
            background: var(--text-dark);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn-reveal:hover { background: #333; }
        
        .btn-nav {
            background: #eee;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- UI RESPUESTA (DORSO) --- */
        .answer-stats {
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .stat-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .stat-label { width: 30px; font-weight: bold; }
        .stat-bar-container { flex: 1; background: #eee; height: 20px; border-radius: 10px; margin: 0 10px; overflow: hidden; position: relative; }
        .stat-bar-fill { height: 100%; background: #ccc; width: 0%; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; font-size: 0.75rem; color: white; transition: width 0.5s ease-out; }
        .stat-val { width: 40px; text-align: right; font-weight: bold; }

        .bar-correct { background: var(--success-color) !important; }
        .bar-wrong { background: var(--error-color) !important; opacity: 0.6; }

        .result-box {
            padding: 15px;
            border-radius: 12px;
            background: rgba(255,255,255,0.5);
            margin-bottom: 1rem;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* --- MODAL --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 1.5rem; }
        .btn-modal { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
        .btn-modal-cancel { background: #eee; color: #333; }
        .btn-modal-ok { background: var(--error-color); color: white; }

        /* --- RESULTADOS FINALES --- */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 2rem 0;
            text-align: left;
        }
        
        .summary-box {
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 16px;
        }

        .topic-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .topic-item {
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 8px 0;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }
        .badge-fail {
            background: #ffebee; color: var(--error-color);
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 600px) {
            .flip-card { height: 750px; }
            .summary-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <!-- MODAL CONFIRMACION -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">¿Finalizar Sesión?</div>
            <p>Se mostrarán los resultados de las preguntas respondidas hasta ahora. Las preguntas restantes se ignorarán.</p>
            <div class="modal-btns">
                <button class="btn-modal btn-modal-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn-modal btn-modal-ok" onclick="confirmEndSession()">Finalizar</button>
            </div>
        </div>
    </div>

    <!-- PANTALLA INICIO -->
    <div id="start-screen" class="screen active container">
        <div class="glass-panel">
            <h1>Sondeo: Servidumbres</h1>
            <p class="subtitle">Modo Votación Grupal </p>
            
            <div class="creators">
                Cuestionario creado por Magda Marleny Cárdenas Suarez, Diana Catalina Mora Romero, Crystel Yohana Moreno Pérez y Carlos Mario Agamez
            </div>

            <div style="margin: 2rem 0;">
                <label class="selection-label">Número de preguntas:</label>
                <div class="btn-grid" style="margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center; gap:5px;">
                    <button class="btn-select" onclick="selectQCount(5, this)">5</button>
                    <button class="btn-select selected" onclick="selectQCount(10, this)">10</button>
                    <button class="btn-select" onclick="selectQCount(15, this)">15</button>
                    <button class="btn-select" onclick="selectQCount(20, this)">20</button>
                    <button class="btn-select" onclick="selectQCount(24, this)">24</button>
                    <button class="btn-select" onclick="selectQCount(30, this)">30</button>
                    <button class="btn-select" onclick="selectQCount(34, this)">34</button>
                </div>
            </div>

            <button class="btn-main" onclick="startSession()">Iniciar Sesión de Votación</button>
        </div>
    </div>

    <!-- PANTALLA SONDEO (PREGUNTA) -->
    <div id="quiz-screen" class="screen container">
        <div class="flip-card" id="card">
            <div class="flip-card-inner">
                
                <!-- FRENTE: VOTACIÓN -->
                <div class="flip-card-front">
                    <div class="top-bar">
                        <span>Pregunta <span id="q-curr">1</span>/<span id="q-total">10</span></span>
                        <span style="color: var(--primary-color);">Votos Totales: <span id="total-votes-live">0</span></span>
                    </div>

                    <div class="question-text" id="q-text">...</div>

                    <!-- Grid de opciones con contadores -->
                    <div class="voting-grid" id="voting-container">
                        <!-- Se llena dinámicamente -->
                    </div>

                    <div class="action-footer">
                        <button class="btn-nav" id="btn-prev-front" onclick="prevQuestion()" style="visibility: hidden;">Anterior</button>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-select" onclick="resetCurrentVotes()" style="font-size: 0.8rem;">Reiniciar Votos</button>
                            <button class="btn-reveal" onclick="revealAnswer()">Revelar Respuesta</button>
                        </div>
                    </div>
                </div>

                <!-- DORSO: RESULTADOS DE PREGUNTA -->
                <div class="flip-card-back">
                    <h2 style="margin-bottom:1rem;">Resultados de la Votación</h2>
                    
                    <!-- Gráfico de barras -->
                    <div class="answer-stats" id="stats-container">
                        <!-- Barras dinámicas -->
                    </div>

                    <div class="result-box">
                        <div style="font-weight:bold; margin-bottom:5px;">Respuesta Correcta:</div>
                        <div id="correct-answer-display" style="color:var(--success-color); font-size:1.1rem; margin-bottom:10px;"></div>
                        <div id="explanation-display" style="font-size:0.95rem; line-height:1.4;"></div>
                    </div>

                    <div class="action-footer" style="justify-content: center; gap: 20px;">
                        <button class="btn-nav" onclick="prevQuestion()">Anterior</button>
                        <button class="btn-select" onclick="openModal()">Finalizar Todo</button>
                        <button class="btn-main" onclick="nextQuestion()">Siguiente</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- PANTALLA FINAL (ESTADÍSTICAS GLOBALES) -->
    <div id="result-screen" class="screen container">
        <div class="glass-panel">
            <h1>Informe de la Sesión</h1>
            
            <div class="summary-grid">
                <div class="summary-box">
                    <h3>Resumen General</h3>
                    <div style="font-size:3rem; font-weight:bold; color:var(--primary-color); margin:10px 0;" id="avg-score">0%</div>
                    <p>Efectividad del Grupo (Promedio)</p>
                    <p style="margin-top:10px; font-size:0.9rem; color:#666;">
                        Total Votos Registrados: <span id="grand-total-votes">0</span>
                    </p>
                </div>

                <div class="summary-box">
                    <h3>Temas a Reforzar</h3>
                    <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Preguntas con mayor tasa de error (>50%)</p>
                    <ul class="topic-list" id="weak-topics-list">
                        <!-- Lista dinámica -->
                    </ul>
                </div>
            </div>

            <button class="btn-main" onclick="location.reload()">Nueva Sesión</button>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE PREGUNTAS ACTUALIZADA ---
        const rawQuestions = [
            {
                q: "Según la definición legal del artículo 879, ¿cuál es la naturaleza jurídica esencial de la servidumbre predial?",
                opts: { A: "Contrato personal intransferible.", B: "Obligación de hacer del dueño sirviente.", C: "Gravamen impuesto sobre un predio en utilidad de otro.", D: "Derecho real accesorio de copropiedad." },
                correct: "C",
                expl: "La servidumbre es un gravamen real, no una obligación personal. Recae sobre el predio (inmueble) y no sobre la persona."
            },
            {
                q: "¿Cuál de las siguientes opciones describe correctamente una servidumbre continua?",
                opts: { A: "Requiere presencia constante del dueño.", B: "Se ejerce sin necesidad de un hecho actual del hombre.", C: "Presenta una señal exterior visible.", D: "Se ejerce a intervalos regulares." },
                correct: "B",
                expl: "La clave de la continuidad (Art. 881 C.C.) es que no requiere un 'hecho actual del hombre' para funcionar (Ej: acueducto)."
            },
            {
                q: "Para adquirir una servidumbre por prescripción (usucapión), ¿qué requisito es indispensable?",
                opts: { A: "Que sea continua y aparente.", B: "Que sea discontinua y aparente.", C: "Que exista título precario.", D: "Que sea legal o natural." },
                correct: "A",
                expl: "Las servidumbres discontinuas y las inaparentes solo pueden adquirirse por título; no basta el tiempo para prescribirlas (Art. 939)."
            },
            {
                q: "Respecto a servidumbres naturales (aguas), ¿cuál es la obligación del predio inferior?",
                opts: { A: "Recibir todas las aguas, incluidas industriales.", B: "Puede bloquearlas con diques.", C: "Recibir aguas de descenso natural sin estorbarlas.", D: "Recibir aguas, pero el superior puede desviarlas." },
                correct: "C",
                expl: "Debe recibir las aguas que descienden naturalmente. No puede estorbarlas, ni el superior agravarlas."
            },
            {
                q: "Si una pared divisoria fue construida exclusivamente a expensas de uno de los vecinos, ¿qué presunción aplica?",
                opts: { A: "Se presume medianera siempre.", B: "Se presume propiedad exclusiva del que la costeó.", C: "Se vuelve medianera automáticamente.", D: "Se presume baldía." },
                correct: "B",
                expl: "La presunción de medianería se desvirtúa si hay títulos o señales que demuestren que la hizo uno solo (Art. 910, 911)."
            },
            {
                q: "¿Cuál es la condición sine qua non para exigir la servidumbre legal de tránsito (Art. 905)?",
                opts: { A: "Que sea el camino más corto.", B: "Que el predio esté enclavado (sin comunicación).", C: "Pagar arriendo mensual.", D: "Que no haya cultivos." },
                correct: "B",
                expl: "La ley otorga este derecho únicamente cuando el predio se encuentra 'enclavado' o destituido de comunicación con la vía pública."
            },
            {
                q: "¿Cómo se computa el tiempo para la extinción por no uso?",
                opts: { A: "Desde el día de constitución.", B: "Discontinuas: último goce. Continuas: acto contrario.", C: "Continuas: último día de lluvia.", D: "10 años desde visita notarial." },
                correct: "B",
                expl: "Art. 942: Para discontinuas cuenta desde el último uso; para continuas, desde que ocurre un acto que la bloquee."
            },
            {
                q: "Según el Art. 883 (inseparabilidad), ¿qué sucede si se vende el predio dominante?",
                opts: { A: "La servidumbre se extingue.", B: "Queda con el antiguo dueño.", C: "Pasa al nuevo propietario.", D: "Se vuelve obligación personal." },
                correct: "C",
                expl: "La servidumbre es inseparable del predio. Pasa automáticamente con él en cualquier traspaso."
            },
            {
                q: "¿Qué regla establece el Código Civil sobre ventanas con vista recta hacia el vecino?",
                opts: { A: "Permitidas con rejas.", B: "Sin restricción en pared propia.", C: "Prohibidas sin distancia mínima legal (3m aprox).", D: "Prohibidas solo si afectan la moral." },
                correct: "C",
                expl: "Se prohíben vistas directas o balcones sin respetar la distancia legal mínima para proteger la privacidad."
            },
            {
                q: "¿Puede el dueño del predio sirviente alterar la servidumbre?",
                opts: { A: "Sí, a su arbitrio.", B: "No, salvo que ofrezca variación a su costa si es muy onerosa.", C: "Sí, puede cerrarla.", D: "No, nunca." },
                correct: "B",
                expl: "No puede alterarla, pero si le causa graves perjuicios, puede ofrecer variarla a su costa ofreciendo otra ubicación igual de cómoda."
            },
            {
                q: "Es el derecho real que posee el propietario de un predio para aprovecharse de otro predio:",
                opts: { A: "Concepto de servidumbre.", B: "Derecho de servidumbre (perspectiva activa).", C: "Forma de constitución.", D: "Forma de extinción." },
                correct: "B",
                expl: "Aunque el texto presenta definiciones similares, esta corresponde a la perspectiva del predio dominante (quien posee el derecho)."
            },
            {
                q: "¿Cuál de los siguientes es un ejemplo de servidumbre personal (derecho romano)?",
                opts: { A: "Servidumbre sobre predios rústicos.", B: "Acueducto.", C: "Paso.", D: "El usufructo." },
                correct: "D",
                expl: "En el derecho romano y doctrina clásica, el usufructo, uso y habitación se distinguían como servidumbres personales frente a las prediales."
            },
            {
                q: "Es un principio rector de la servidumbre respecto a su finalidad:",
                opts: { A: "Debe ser temporal.", B: "Se establece por utilidad objetiva del fundo.", C: "Opera en predios no vecinos.", D: "Se puede tener en fundo propio." },
                correct: "B",
                expl: "La utilidad debe ser objetiva para el beneficio del fundo, no un mero capricho personal del dueño."
            },
            {
                q: "La servidumbre consiste en un poder jurídico ejercido directa e inmediatamente sobre una cosa y es oponible erga omnes. Esto se refiere a:",
                opts: { A: "Obligación personal.", B: "Elemento de derecho real.", C: "Atributo del predio sirviente.", D: "Contrato bilateral." },
                correct: "B",
                expl: "Esta definición describe la naturaleza de la servidumbre como un Derecho Real."
            },
            {
                q: "La servidumbre se trata de 'iura in re aliena', lo que significa:",
                opts: { A: "Derechos sobre cosa ajena.", B: "Derechos sobre cosa propia.", C: "Derechos de familia.", D: "Derechos de crédito." },
                correct: "A",
                expl: "Tanto servidumbres como usufructo son derechos reales sobre cosa ajena (predio de distinto dueño)."
            },
            {
                q: "Se denomina predio sirviente al:",
                opts: { A: "Predio beneficiario.", B: "Predio que tiene la utilidad.", C: "Predio dominante.", D: "Predio que sufre el gravamen." },
                correct: "D",
                expl: "Es el predio que soporta la carga o gravamen en beneficio de otro."
            },
            {
                q: "¿Cuál es una característica procesal clave de la servidumbre?",
                opts: { A: "Es una obligación positiva.", B: "Se defiende por la acción reivindicatoria.", C: "Solo se constituye por testamento.", D: "Se defiende por la acción confesoria." },
                correct: "D",
                expl: "La acción confesoria es la vía judicial específica para defender la existencia y ejercicio de este derecho real."
            },
            {
                q: "En la clasificación clásica, comprendía el pasaje, la conducción, el camino y el acueducto:",
                opts: { A: "Servidumbres urbanas.", B: "Servidumbres rústicas.", C: "Servidumbres personales.", D: "Servidumbres administrativas." },
                correct: "B",
                expl: "Históricamente (Roma), las servidumbres de campo (rústicas) incluían iter, actus, via y aquaeductus."
            },
            {
                q: "Las servidumbres 'altius tollendi' (levantar más alto) o 'ne luminibus officiatur' (no impedir luces) son ejemplos de:",
                opts: { A: "Servidumbres rústicas.", B: "Servidumbres urbanas.", C: "Jus prospectus.", D: "Servidumbres de paso." },
                correct: "B",
                expl: "Son servidumbres relacionadas con la edificación y convivencia en ciudades (urbanas)."
            },
            {
                q: "¿Cuál de las siguientes NO es una característica jurídica de las servidumbres?",
                opts: { A: "Perpetuidad (unidas a la propiedad).", B: "Indivisibilidad.", C: "Divisibilidad (se pueden adquirir parcialmente).", D: "Carácter accesorio." },
                correct: "C",
                expl: "La servidumbre es Indivisible. No se pueden adquirir, ejercer ni perder parcialmente."
            },
            {
                q: "Según su fuente, las servidumbres pueden ser:",
                opts: { A: "Solo naturales.", B: "Solo legales.", C: "Naturales, Legales y Voluntarias.", D: "Solo judiciales." },
                correct: "C",
                expl: "Se clasifican según su origen en Naturales (situación de los lugares), Legales (impuestas por la ley) y Voluntarias (hecho del hombre)."
            },
            {
                q: "Para la servidumbre por 'destino del padre de familia', se requiere:",
                opts: { A: "Que los dos predios hayan pertenecido al mismo dueño.", B: "Que el dueño estableciera un servicio continuo y aparente.", C: "Que al separarse los predios no se estipule lo contrario.", D: "Todas las anteriores." },
                correct: "D",
                expl: "Requiere unidad de dueño previo, establecimiento de un servicio visible (estado de hecho) y falta de estipulación contraria al enajenar."
            },
            {
                q: "¿En qué consiste el objeto obligacional (contenido) de las servidumbres para el predio sirviente?",
                opts: { A: "En una obligación de hacer (ejecutar obras).", B: "En un 'no hacer' o en 'tolerar'.", C: "En pagar una renta.", D: "En ceder la propiedad." },
                correct: "B",
                expl: "La servidumbre no obliga a 'hacer' (salvo pacto o ley expresa), sino a soportar (tolerar) o abstenerse de hacer algo (no hacer)."
            },
            {
                q: "¿Cómo se define la continuidad de una servidumbre?",
                opts: { A: "Uso diario.", B: "Uso incesante sin intervención humana actual.", C: "Uso a intervalos.", D: "Uso perpetuo." },
                correct: "B",
                expl: "Son aquellas cuyo uso es o puede ser incesante sin necesidad de un hecho actual del hombre (ej. acueducto, desagüe)."
            },
            {
                q: "¿Cuáles son ejemplos de servidumbres legales expresamente reguladas?",
                opts: { A: "Uso y Habitación.", B: "Hipoteca y Prenda.", C: "Demarcación, Cerramiento, Tránsito, Acueducto, Luz y Vista.", D: "Solo Tránsito." },
                correct: "C",
                expl: "El Código regula expresamente el uso de las riberas, demarcación, cerramiento, tránsito, acueducto, luz y vista como servidumbres legales."
            },
            {
                q: "La servidumbre voluntaria por contrato implica:",
                opts: { A: "Imposición judicial.", B: "Acuerdo de voluntades para constituir el gravamen.", C: "Muerte del causante.", D: "Usucapión." },
                correct: "B",
                expl: "Nace de la autonomía de la voluntad a través de un negocio jurídico (título) entre las partes."
            },
            {
                q: "¿Qué servidumbres se pueden adquirir por prescripción?",
                opts: { A: "Todas.", B: "Solo las discontinuas.", C: "Solo las continuas y aparentes.", D: "Solo las inaparentes." },
                correct: "C",
                expl: "La prescripción adquisitiva solo aplica para servidumbres que sean a la vez continuas y aparentes."
            },
            {
                q: "¿Qué es una servidumbre por adjudicación o sentencia?",
                opts: { A: "La que nace por naturaleza.", B: "La otorgada por autoridad judicial (ej. división de bienes o imposición legal).", C: "La que se compra.", D: "La de facto." },
                correct: "B",
                expl: "Es aquella declarada o constituida mediante fallo judicial, usualmente en procesos divisorios o para imponer servidumbres forzosas."
            },
            {
                q: "¿Cuál es una obligación principal del dueño del predio sirviente?",
                opts: { A: "Construir las obras del acueducto.", B: "No alterar ni menoscabar la servidumbre.", C: "Pagar al dueño dominante.", D: "Usar la servidumbre él también obligatoriamente." },
                correct: "B",
                expl: "Tiene el deber de abstención: no puede alterar, disminuir ni hacer más incómoda la servidumbre para el predio dominante."
            },
            {
                q: "¿Cuál es una obligación del dueño del predio dominante?",
                opts: { A: "Pagar impuestos del predio sirviente.", B: "Hacer las obras necesarias a su costa para el ejercicio de la servidumbre.", C: "Pedir permiso cada vez que pase.", D: "No tiene obligaciones." },
                correct: "B",
                expl: "Debe costear las obras necesarias para el uso y conservación de la servidumbre y hacerlo sin causar más gravamen del necesario."
            },
            {
                q: "En la servidumbre legal de paso, ¿qué derecho tiene el predio sirviente?",
                opts: { A: "Impedir el paso si llueve.", B: "Ser indemnizado por el valor del terreno y perjuicios.", C: "Cobrar peaje por persona.", D: "Exigir que se construya un túnel." },
                correct: "B",
                expl: "El predio sirviente tiene derecho a que se le pague el valor del terreno ocupado y se le indemnice por los daños causados."
            },
            {
                q: "¿Por dónde se debe trazar la servidumbre de paso?",
                opts: { A: "Por donde quiera el dominante.", B: "Por la mitad del predio.", C: "Por donde sea menor la distancia o menos gravoso para el sirviente.", D: "Siempre por el lindero." },
                correct: "C",
                expl: "Se elegirá el trayecto más corto a la vía pública, y en igualdad de condiciones, el que cause menos perjuicio al predio sirviente."
            },
            {
                q: "El carácter accesorio de la servidumbre implica que:",
                opts: { A: "Es menos importante que el usufructo.", B: "No puede subsistir sin los predios y no se puede enajenar separadamente.", C: "Es un mueble por anticipación.", D: "Se extingue con la muerte del dueño." },
                correct: "B",
                expl: "Está ligada inseparablemente al predio. Si se vende el predio, se vende la servidumbre con él."
            },
            {
                q: "¿Qué significa que la servidumbre sea indivisible?",
                opts: { A: "Que no se puede partir el terreno.", B: "Que si el predio se divide, la servidumbre no se modifica y cada parte la soporta o disfruta.", C: "Que dura para siempre.", D: "Que solo puede tener un dueño." },
                correct: "B",
                expl: "Si el predio sirviente se divide, la servidumbre no varía y cada nuevo dueño debe tolerarla en la parte que le corresponda."
            }
        ];

        // --- STATE ---
        let sessionLimit = 10;
        let activeQuestions = [];
        let currentIndex = 0;
        let currentVotes = { A:0, B:0, C:0, D:0 };
        // sessionData[index] guardará los votos y estado de cada pregunta
        let sessionData = []; 

        // --- DOM ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const card = document.getElementById('card');
        
        const qCurr = document.getElementById('q-curr');
        const qTotal = document.getElementById('q-total');
        const totalVotesDisplay = document.getElementById('total-votes-live');
        const qText = document.getElementById('q-text');
        const votingContainer = document.getElementById('voting-container');
        const btnPrevFront = document.getElementById('btn-prev-front');
        
        const statsContainer = document.getElementById('stats-container');
        const correctDisplay = document.getElementById('correct-answer-display');
        const explDisplay = document.getElementById('explanation-display');
        
        const modal = document.getElementById('modal-confirm');

        // --- SETUP ---
        function selectQCount(n, btn) {
            sessionLimit = n;
            document.querySelectorAll('.btn-select').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function shuffle(arr) {
            return arr.sort(() => Math.random() - 0.5);
        }

        function startSession() {
            // Si piden más preguntas de las que hay, usar el máximo posible
            const limit = Math.min(sessionLimit, rawQuestions.length);
            activeQuestions = shuffle([...rawQuestions]).slice(0, limit);
            
            currentIndex = 0;
            // Inicializar array de datos vacío
            sessionData = new Array(activeQuestions.length).fill(null);
            
            startScreen.classList.remove('active');
            quizScreen.classList.add('active');
            loadQuestion();
        }

        // --- CORE LOGIC ---
        function loadQuestion() {
            // Verificar si hay datos guardados para esta pregunta
            const savedData = sessionData[currentIndex];
            
            if (savedData) {
                // Restaurar votos guardados
                currentVotes = { ...savedData.votes };
            } else {
                // Resetear votos
                currentVotes = { A:0, B:0, C:0, D:0 };
            }

            // Asegurarse de que muestre el frente inicialmente (para votar o revotar)
            // Si quisieras que muestre el resultado si ya se respondió, podrías verificar savedData.revealed
            card.classList.remove('flipped');
            
            const q = activeQuestions[currentIndex];

            // Update UI
            qCurr.innerText = currentIndex + 1;
            qTotal.innerText = activeQuestions.length;
            qText.innerText = q.q;
            
            // Actualizar total visual
            const total = Object.values(currentVotes).reduce((a,b)=>a+b, 0);
            totalVotesDisplay.innerText = total;

            // Botón Anterior (visibilidad)
            btnPrevFront.style.visibility = currentIndex > 0 ? 'visible' : 'hidden';

            renderVotingGrid(q.opts);
            
            // Si ya teníamos votos, actualizar las barras visuales del frente
            if (total > 0) updateLiveBars(total);
        }

        function renderVotingGrid(opts) {
            votingContainer.innerHTML = '';
            for (const [key, text] of Object.entries(opts)) {
                const row = document.createElement('div');
                row.className = 'vote-row';
                row.id = `row-${key}`;
                
                const barBg = document.createElement('div');
                barBg.className = 'vote-bar-bg';
                barBg.id = `bar-bg-${key}`;
                
                const content = document.createElement('div');
                content.className = 'vote-content';

                const label = document.createElement('div');
                label.className = 'option-text';
                label.innerHTML = `<strong>${key})</strong> ${text}`;

                const controls = document.createElement('div');
                controls.className = 'vote-controls';
                
                const btnMinus = document.createElement('button');
                btnMinus.className = 'btn-vote';
                btnMinus.innerText = '-';
                btnMinus.onclick = () => modifyVote(key, -1);

                const countDisplay = document.createElement('div');
                countDisplay.className = 'vote-count';
                countDisplay.id = `count-${key}`;
                countDisplay.innerText = currentVotes[key]; // Usar valor actual

                const btnPlus = document.createElement('button');
                btnPlus.className = 'btn-vote';
                btnPlus.innerText = '+';
                btnPlus.onclick = () => modifyVote(key, 1);

                controls.append(btnMinus, countDisplay, btnPlus);
                content.append(label, controls);
                row.append(barBg, content);
                votingContainer.appendChild(row);
            }
        }

        function modifyVote(key, delta) {
            if (delta < 0 && currentVotes[key] <= 0) return;
            currentVotes[key] += delta;
            
            document.getElementById(`count-${key}`).innerText = currentVotes[key];
            const total = Object.values(currentVotes).reduce((a,b)=>a+b, 0);
            totalVotesDisplay.innerText = total;
            updateLiveBars(total);
            
            // Guardar estado temporalmente en sessionData por si navegan sin revelar
            saveCurrentState(false);
        }

        function updateLiveBars(total) {
            for (const key in currentVotes) {
                const val = currentVotes[key];
                const pct = total > 0 ? (val / total) * 100 : 0;
                const el = document.getElementById(`bar-bg-${key}`);
                if(el) el.style.width = `${pct}%`;
            }
        }

        function resetCurrentVotes() {
            currentVotes = { A:0, B:0, C:0, D:0 };
            document.querySelectorAll('.vote-count').forEach(el => el.innerText = '0');
            document.querySelectorAll('.vote-bar-bg').forEach(el => el.style.width = '0%');
            totalVotesDisplay.innerText = '0';
            saveCurrentState(false);
        }

        function saveCurrentState(isRevealed) {
            sessionData[currentIndex] = {
                votes: { ...currentVotes },
                revealed: isRevealed
            };
        }

        function revealAnswer() {
            const q = activeQuestions[currentIndex];
            const total = Object.values(currentVotes).reduce((a,b)=>a+b, 0);
            
            // Guardar estado confirmado
            saveCurrentState(true);

            // Renderizar dorso
            renderStats(q, total);
            
            correctDisplay.innerHTML = `${q.correct}) ${q.opts[q.correct]}`;
            explDisplay.innerHTML = q.expl;

            card.classList.add('flipped');
        }

        function renderStats(q, total) {
            statsContainer.innerHTML = '';
            for (const [key, text] of Object.entries(q.opts)) {
                const count = currentVotes[key];
                const pct = total > 0 ? Math.round((count/total)*100) : 0;
                const isCorrect = (key === q.correct);

                const row = document.createElement('div');
                row.className = 'stat-row';
                
                const label = document.createElement('div');
                label.className = 'stat-label';
                label.innerText = key;
                if(isCorrect) label.style.color = 'var(--success-color)';

                const barCont = document.createElement('div');
                barCont.className = 'stat-bar-container';
                
                const fill = document.createElement('div');
                fill.className = 'stat-bar-fill';
                fill.style.width = `${pct}%`;
                
                if (isCorrect) fill.classList.add('bar-correct');
                else if (!isCorrect && pct > 0) fill.classList.add('bar-wrong');
                
                fill.innerText = pct > 5 ? `${count} (${pct}%)` : '';

                barCont.appendChild(fill);
                
                const val = document.createElement('div');
                val.className = 'stat-val';
                val.innerText = count;

                row.append(label, barCont, val);
                statsContainer.appendChild(row);
                
                setTimeout(() => fill.style.width = `${pct}%`, 50);
            }
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                loadQuestion();
            }
        }

        function nextQuestion() {
            if (currentIndex < activeQuestions.length - 1) {
                currentIndex++;
                loadQuestion();
            } else {
                openModal();
            }
        }

        // --- MODAL & FINISH ---
        function openModal() {
            modal.classList.add('active');
        }
        function closeModal() {
            modal.classList.remove('active');
        }
        function confirmEndSession() {
            closeModal();
            finishSession();
        }

        function finishSession() {
            quizScreen.classList.remove('active');
            resultScreen.classList.add('active');
            renderFinalReport();
        }

        function renderFinalReport() {
            let grandTotalVotes = 0;
            let grandTotalCorrect = 0;
            let weakTopics = [];

            // Iterar sobre sessionData (que coincide en índice con activeQuestions)
            sessionData.forEach((data, index) => {
                if (!data || !data.revealed) return; // Ignorar no respondidas

                const q = activeQuestions[index];
                const totalVotes = Object.values(data.votes).reduce((a,b)=>a+b, 0);
                const correctCount = data.votes[q.correct];

                grandTotalVotes += totalVotes;
                grandTotalCorrect += correctCount;

                // Identificar temas débiles (<50%)
                const accuracy = totalVotes > 0 ? (correctCount / totalVotes) : 0;
                if (accuracy < 0.5) {
                    weakTopics.push({
                        q: q.q,
                        acc: Math.round(accuracy * 100)
                    });
                }
            });

            const globalAvg = grandTotalVotes > 0 ? Math.round((grandTotalCorrect / grandTotalVotes) * 100) : 0;
            
            document.getElementById('avg-score').innerText = `${globalAvg}%`;
            document.getElementById('grand-total-votes').innerText = grandTotalVotes;

            const list = document.getElementById('weak-topics-list');
            list.innerHTML = '';
            
            if (grandTotalVotes === 0) {
                list.innerHTML = '<li>No se registraron datos suficientes.</li>';
            } else if (weakTopics.length === 0) {
                list.innerHTML = '<li style="padding:10px; color:green;">¡Excelente! El grupo dominó todos los temas tratados.</li>';
            } else {
                weakTopics.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'topic-item';
                    li.innerHTML = `
                        <span style="flex:1; padding-right:10px;">${t.q}</span>
                        <span class="badge-fail">${t.acc}% Acierto</span>
                    `;
                    list.appendChild(li);
                });
            }
        }
    </script>
</body>

</html>
